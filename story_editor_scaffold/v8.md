# v8.md — Thiết kế tính năng “Lấy ảnh” (tự động lấy ảnh chương truyện)

> Mục tiêu: Tự động mở URL chương truyện trong trình duyệt điều khiển (Selenium/Playwright), tải hết ảnh (lazy-load), loại bỏ quảng cáo an toàn, chụp/lưu toàn bộ chương, cắt tách từng trang chuẩn, loại bỏ trang giả, và xuất ra ảnh/PDF để đưa thẳng vào Project.

---

## 0) Phạm vi & ràng buộc
- **Không click vào quảng cáo** để tránh redirect, reload, popup.
- **Không cần đăng nhập** (nếu site yêu cầu, cần quy trình phụ với cookie).
- **Không vượt quá tốc độ tải** (chèn delay hợp lý).
- Hạn chế: Một số site dùng **anti-bot/Cloudflare** (xem mục 9).

---

## 1) Mở chương bằng trình duyệt tự động
- **Chọn engine**: Selenium **hoặc** Playwright (đề xuất Playwright vì ổn định headless + auto-wait).
- **Thiết lập**:
  - Headless (ẩn UI) + tùy chọn hiển thị (để debug).
  - User-Agent phổ biến của Chrome/Firefox.
  - Tắt ảnh động/notifications nếu cần.
- **Điều hướng**: `page.goto(URL, wait_until='networkidle')` hay tương đương.
- **Kiểm tra**: chờ selector container chính (ví dụ `#chapter-content`, `.reading-detail`, …).

---

## 2) Cuộn xuống để tải hết ảnh (lazy-load)
- **Ý tưởng**: Nhiều trang chỉ tải ảnh khi phần tử **enter viewport**.
- **Thuật toán**:
  1. Đọc `document.body.scrollHeight` ban đầu.
  2. Cuộn từng bước (ví dụ 1200–2000px), **chờ** ảnh xuất hiện (timeout ngắn).
  3. Lặp cho đến khi `scrollHeight` **không tăng thêm** (liên tiếp 2–3 lần).
- **Bổ sung**:
  - Truy xuất tất cả `img` trong DOM, kiểm tra `src`/`data-src` đã **đã đổ đầy** chưa (nếu trang dùng attribute lazy).
  - Nếu có **Infinite scroll**: phát hiện nút “Xem thêm” / “Load more” và click **một lần** (không phải quảng cáo).

---

## 3) Ẩn hoặc xóa quảng cáo (an toàn)
- **Không click tắt** (tránh redirect/reload/popup).
- **Cách làm**:
  - Tiêm **CSS**: `display:none !important` cho các selector nghi vấn.
  - Hoặc **xóa khỏi DOM** bằng JS: `el.remove()`.
- **Nhận diện quảng cáo** (heuristics):
  - selector chứa từ: `ad`, `ads`, `banner`, `adsbox`, `sponsor`, `promo`, `popup`, `iframe[src*='ad']`.
  - phần tử **`position: fixed`** bám trên/dưới/trái/phải.
  - iframe từ domain quảng cáo.
- **Thời điểm thực hiện**:
  - Sau khi trang render lần đầu.
  - **Mỗi lần** sau khi scroll thêm (để ẩn các ad xuất hiện muộn).
- **Kết quả**: giao diện hiển thị như bình thường, **không có ad** trong khung chụp.

---

## 4) Lưu toàn bộ chương (2 lựa chọn)
1) **Ảnh dài (full screenshot)**  
   - Chụp full page, thu được **1 ảnh dài** chứa toàn bộ chương.
   - Ưu: đơn giản, dễ tách trang bằng phân tích khoảng trắng.
   - Nhược: ảnh có thể rất dài (kích thước lớn).

2) **PDF từ “In”**  
   - Dùng tính năng in ảo (emulation) để xuất sang **PDF**.
   - Ưu: gọn, dễ lưu trữ/chia sẻ.
   - Nhược: tách ảnh từ PDF cần thêm bước trích xuất; đôi khi CSS in làm thay đổi bố cục.

> Có thể hỗ trợ **cả hai** và cho phép người dùng chọn.

---

## 5) Xác định ranh giới từng trang (từ ảnh dài)
- **Đặc trưng**: giữa các trang truyện thường có **khoảng trắng ngang** kéo dài hết chiều rộng.
- **Phân tích theo hàng (scanline)**:
  - Duyệt từng **hàng pixel** theo trục Y.
  - Tính tỉ lệ “trắng” (ví dụ RGB gần trắng) trên hàng đó.
  - Hàng có **≥ 95% pixel trắng** → đánh dấu là **hàng trắng**.
- **Tìm đoạn trắng liên tục**:
  - Gom các hàng trắng liên tiếp thành **“dải trắng”**.
  - Dải đủ **chiều cao tối thiểu** (ví dụ ≥ 20–30px) → coi là **ranh giới**.

---

## 6) Cắt thành từng trang riêng
- Dò từ **đầu ảnh → dải trắng 1**: cắt thành `page_001`.
- Từ **dải trắng 1 → dải trắng 2**: `page_002`, …
- **Cuối ảnh**: cắt nốt phần còn lại.
- **Tên file**: `page_001.png`, `page_002.png`, … (zero padding để sort đúng).
- **Chuẩn hóa kích thước** (tuỳ chọn):
  - Chừa **lề nhỏ** (crop thêm 2–4px) để tránh dính mép trắng.
  - Đảm bảo chiều rộng/chiều cao tối thiểu.

---

## 7) Loại bỏ “trang giả” (ad chèn giữa nội dung)
- **Heuristics**:
  - **Chiều cao nhỏ** hơn ngưỡng (ví dụ `< 400px`) → khả năng cao là banner/quảng cáo.
  - **Tỷ lệ ngang/cao bất thường** so với trang truyện (truyện thường **hẹp ngang, cao**).
  - **Độ biến thiên màu** thấp/đồ họa khác biệt (tuỳ chọn nâng cao).
- Nếu khớp 1–2 tiêu chí → **bỏ qua** (không lưu file trang đó).

---

## 8) Xuất kết quả
- **Ảnh rời**: Lưu các trang đạt chuẩn vào thư mục, sẵn sàng cho OCR/dịch/biên tập.
- **PDF**: Tuỳ chọn gom các trang ảnh thành 1 PDF (để lưu trữ/đọc).
- **Tích hợp vào Project**:
  - Sau khi có danh sách ảnh `page_*.png`, **import** vào Editor như **Import Ảnh**: mỗi ảnh → 1 hàng (cột text trống).

---

## 9) Xử lý các vấn đề thực tế
- **Anti-bot / Cloudflare**: có thể cần
  - Delay người thật (random 200–800ms).
  - **Viewport** & UA hợp lý.
  - Tải cookie phiên (nếu đã đăng nhập).
- **Infinite Scroll dài**: đặt **giới hạn trang** hoặc chiều cao cuộn tối đa để tránh lặp vô hạn.
- **Lazy-load bằng `data-src`**: inject JS ép gán `img.src = img.dataset.src` khi đã vào viewport.
- **Hiệu năng**: Full screenshot rất dài → dùng định dạng **PNG** (không mất dữ liệu) hoặc **JPEG chất lượng cao** nếu dung lượng quan trọng.

---

## 10) Tham số tinh chỉnh (khuyến nghị)
- **Ngưỡng trắng**: 95% (có thể 92–98% tùy site).
- **Min height dải trắng**: 20–40px.
- **Min page height**: 350–450px.
- **Delay scroll**: 120–250ms mỗi bước.
- **Số context ad-erase**: gọi lại **ẩn/xóa ad** sau mỗi 3–4 bước cuộn.

---

## 11) Dòng chảy tổng quát (tóm tắt)
1. **Mở URL** chương (Selenium/Playwright), chờ DOM chính.  
2. **Cuộn** đến cuối để lazy-load **toàn bộ ảnh**.  
3. **Ẩn/Xóa quảng cáo** bằng CSS/JS (không click).  
4. **Chụp full page** hoặc **In ra PDF**.  
5. **Phân tích khoảng trắng** ngang → xác định **ranh giới trang**.  
6. **Cắt** thành `page_001, page_002, …`.  
7. **Loại bỏ trang giả** theo kích thước/tỷ lệ.  
8. **Xuất ảnh/PDF** và **import** vào Project.

---

## 12) UX của cửa sổ “Lấy ảnh…” (dialog)
- **Inputs**:
  - Ô nhập **URL chương**.
  - Nút **Tải**.
  - Lựa chọn **Chụp ảnh dài / Xuất PDF**.
  - Tùy chọn **ngưỡng trắng** / **min page height** (nâng cao).
- **Preview bước cuối**: hiển thị **thumbnail** các `page_XXX` sẽ import.
- **Nút Import**: đưa ảnh vào **cuối Project** (append).
- **Lưu cấu hình**: nhớ URL gần nhất, đường dẫn xuất, tuỳ chọn người dùng (qua `Settings`).

---

## 13) An toàn & pháp lý
- Tôn trọng **điều khoản sử dụng** của website nguồn.
- Kiểm tra **robots.txt** và các quy định bản quyền.
- Dùng cho **mục đích cá nhân/biên tập**; không phát tán nội dung khi không được phép.

---

## 14) Tương tác với các module khác
- **Editor**: sau khi import, người dùng có thể **crop trực tiếp**, chèn/xoá/duplicate, gọi API xử lý từng ảnh.
- **Prompt/Gemini**: ảnh vừa lấy có thể dùng ngay ở luồng “Xử lý ảnh này” (context 5–6 đoạn phía trên).

---

### Kết luận
Quy trình “Lấy ảnh” được thiết kế để **ổn định, an toàn, ít tương tác giả** (không click quảng cáo), tạo đầu vào sạch cho pipeline OCR/Dịch/Kể chuyện. Khi cần, có thể mở rộng thêm **tìm ảnh theo keyword**, **trích khung từ video**, hoặc **bypass nhẹ anti-bot** (tuân thủ pháp lý).

