# Hướng dẫn phát triển Story Editor – v4

Phiên bản này tập trung vào **4 thay đổi lớn**:  
1. Crop trực tiếp trên ảnh (không cần “Crop Mode”).  
2. Dropdown Prompt luôn hiển thị khi chọn công cụ **Gemini**.  
3. Thêm tính năng **Close Project** để quay về màn hình chờ.  
4. Thêm Undo/Redo cho thao tác Crop và chỉnh sửa văn bản.

---

## 1. Crop trực tiếp (Direct Crop)

### Cơ chế
- Gắn **eventFilter** cho `QLabel` hiển thị ảnh.  
- Lắng nghe các sự kiện:
  - `mousePressEvent`: ghi lại tọa độ bắt đầu.  
  - `mouseMoveEvent`: vẽ khung chữ nhật tạm thời (overlay bằng `QPainter`).  
  - `mouseReleaseEvent`: lấy tọa độ kết thúc, cắt ảnh ngay lập tức bằng OpenCV/PIL, thay thế ảnh gốc.  

### Điểm quan trọng
- Không cần menu chuột phải hay “Crop Mode”.  
- Người dùng chỉ cần **kéo–thả chuột trên ảnh** để cắt.  
- Nếu vùng crop quá nhỏ (<10x10 px) thì bỏ qua.  

---

## 2. Prompt Dropdown cho Gemini

### Yêu cầu
- Toolbar gồm:
  ```
  Save | Import Ảnh | Import Văn bản | Công cụ [Gemini/OCR...] | Prompt [combobox] | Giữ ngữ cảnh | Run | Close
  ```
- Khi chọn Gemini:
  - Hiện nhãn **Prompt** và combobox Prompt.  
  - Có nút “…” mở **Prompt Manager** (thêm/sửa prompt).  
  - Danh sách prompt được load từ file JSON (`config/prompts.json`).  

### Cách làm
- Trong `MainWindow._on_tool_changed`:  
  - Nếu tool == Gemini → `prompt_label.show()`, `prompt_combo.show()`.  
  - Ngược lại → `prompt_label.hide()`, `prompt_combo.hide()`.

---

## 3. Close Project

### Yêu cầu
- Menu **File → Close Project**.  
- Toolbar có nút **Close**.  
- Khi bấm:
  - Đóng project hiện tại.  
  - Lưu project vào **Recent Projects** (`config/recent.json`).  
  - Hiển thị lại màn hình `StartScreen`.  

### Start Screen
- Hiển thị logo + tiêu đề **Story Editor**.  
- Hai nút lớn ở giữa: **New Project** / **Open Project**.  
- Bên dưới: danh sách **Recent Projects** (click mở nhanh).  
- Giao diện bo góc, căn giữa, hiện đại và thoáng.  

---

## 4. Undo/Redo

### Cơ chế
- Sử dụng **stack** để lưu trạng thái:
  - `undo_stack`: chứa các trạng thái trước đó.  
  - `redo_stack`: chứa các trạng thái đã undo.  

### Khi Crop
- Trước khi crop: đẩy ảnh gốc vào `undo_stack`.  
- Sau khi crop: xóa `redo_stack` (reset).  

### Khi Undo
- Lấy ảnh từ `undo_stack` → đưa vào `redo_stack`.  
- Cập nhật lại ảnh hiển thị.  

### Khi Redo
- Lấy ảnh từ `redo_stack` → đưa vào `undo_stack`.  
- Cập nhật lại ảnh hiển thị.  

### Menu/Toolbar
- Menu **Edit → Undo / Redo** (Ctrl+Z / Ctrl+Y).  
- Toolbar có icon Undo ↶ và Redo ↷.  

### Lưu ý
- Undo/Redo áp dụng cho:
  - Thao tác Crop ảnh.  
  - Chỉnh sửa text trong editor (có thể dùng sẵn `QTextEdit.undo()` và `redo()`).  

### Sơ đồ Undo/Redo stack

```
Trạng thái ban đầu → [Ảnh gốc]

Crop lần 1 → undo_stack: [Ảnh gốc]
              redo_stack: []

Undo → Lấy từ undo_stack → redo_stack: [Crop1], hiển thị: Ảnh gốc

Redo → Lấy từ redo_stack → undo_stack: [Ảnh gốc], hiển thị: Crop1
```

---

## 5. Hướng mở rộng (tương lai)

- **Quản lý API keys**:
  - Lưu nhiều key → chọn ngẫu nhiên khi gọi Gemini.  
  - Retry khi gặp lỗi (chuyển key khác).  
- **Ngữ cảnh**: khi gửi ảnh + text, lấy kèm 6–7 đoạn trước để đảm bảo mạch truyện.  
- **Import nâng cao**:
  - SRT → 1 block thời gian = 1 hàng.  
  - TXT → 1 đoạn = 1 hàng.  
- **UI/UX**:  
  - Thêm dark mode.  
  - Drag–drop ảnh vào project.  
  - Preview kết quả từ Gemini ngay trong editor.  

---

## 6. Chạy ứng dụng

### Cài đặt
```bash
pip install PyQt5 opencv-python
```

### Khởi chạy
```bash
python run.py
```

---

## Tóm tắt
Phiên bản v4 đã hoàn thiện khung ứng dụng:
- **Crop trực tiếp** dễ dùng.  
- **Prompt dropdown** tích hợp cho Gemini.  
- **Close Project** trả về màn hình chờ chuyên nghiệp.  
- **Undo/Redo** cho cả crop và chỉnh sửa văn bản.  

Tiếp theo: mở rộng API handling, ngữ cảnh xử lý, và import file thông minh.
