# v5.md – Hoàn thiện menu chuột phải & xử lý từng ảnh

## 1. Menu chuột phải

### Menu Ảnh
- **Thay ảnh**: mở dialog chọn file, thay ảnh hiện tại.
- **Xóa ảnh**: xóa ảnh trong card (text giữ nguyên).
- **Chèn TRÊN / Chèn DƯỚI**: tạo hàng mới **chỉ copy ảnh** từ hàng hiện tại, text để trống.
- **Chèn TRÊN (cả 2) / Chèn DƯỚI (cả 2)**: duplicate cả ảnh & text thành một hàng mới.
- **Xóa CẶP**: xóa cả ảnh & text (xóa hẳn hàng).

### Menu Văn bản
- **Xóa văn bản**: clear text, ảnh giữ nguyên.
- **Chèn TRÊN / Chèn DƯỚI**: tạo hàng mới **chỉ copy text**, ảnh để trống.
- **Chèn TRÊN (cả 2) / Chèn DƯỚI (cả 2)**: duplicate cả ảnh & text.
- **Xóa CẶP**: xóa cả ảnh & text (xóa hẳn hàng).

## 2. Nút “Xử lý ảnh này”
- Mỗi Row (hàng) ảnh có nút **Xử lý ảnh này** ngay dưới ảnh.
- Khi bấm:
  - Lấy ảnh của hàng đó.
  - Lấy **5–6 đoạn text phía trên** (nếu có) làm ngữ cảnh.
  - Gọi API (Gemini) giống như logic `Run` toàn cục.
  - Nếu lỗi, thử API khác trong danh sách (theo random round robin).
  - Kết quả hiển thị ngay trong text box của row đó (ghi đè hoặc append).

## 3. Undo/Redo Crop
- Crop trực tiếp bằng kéo-thả trên ảnh.
- Lịch sử crop của từng row lưu trong stack (undo/redo).
- Undo/Redo áp dụng riêng cho từng ảnh, không ảnh hưởng các row khác.

## 4. Thêm vào EditorScreen
Trong `editor_screen.py`:
- Hàm `run_single_row(row: RowWidget)`:
  - Chuẩn bị ngữ cảnh text phía trên.
  - Gọi API xử lý ảnh đó.
  - Cập nhật text row hiện tại.

## 5. Lưu đường dẫn và API
- Sử dụng `Settings` để nhớ thư mục lần chọn Import Ảnh/Văn bản.
- Danh sách API key lưu trong config, khi chạy sẽ chọn ngẫu nhiên.
- Nếu API fail, thử tiếp key khác → đến khi hết danh sách thì bỏ qua.

## 6. Run toàn bộ app
Dùng Gemini CLI để chạy app:

```bash
gemini run -m gemini-2.0-flash-001 python run.py
