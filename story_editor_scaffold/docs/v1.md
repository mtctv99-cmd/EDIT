# Story Editor – Hướng dẫn v1

Tài liệu này mô tả **cách sử dụng & cấu hình khung giao diện** (UI scaffold) cho dự án kể/tóm tắt/review truyện tranh, kèm **quy ước import ảnh & văn bản** và ghi chú về **Prompt (Gemini)**.

---

## 1) Chuẩn bị môi trường
- Python 3.10+
- Cài thư viện:
  ```bash
  pip install PyQt5 opencv-python numpy
  ```
- Chạy app (bản scaffold):

  ```bash
  python run.py
  ```

---

## 2) Giao diện tổng quan
- **Start Screen**: New Project, Open Project, Recent Projects.
- **Editor Screen**: Lưới **2 cột** (trái Ảnh – phải Văn bản), cuộn dọc; chuột phải trên Ảnh/Text có menu thao tác.
- **Menu bar**: File / Edit / Tools / About.
- **Toolbar**: Save – Import Ảnh… – Import Văn bản… – Tool dropdown (Gemini/OCR) – Prompt (ẩn/hiện theo công cụ) – Giữ ngữ cảnh – Run.

---

## 3) Import Ảnh… (Menu File & Toolbar)
- Hỗ trợ **đa chọn ảnh** (*.png, *.jpg, *.jpeg, *.bmp, *.webp*).
- **Hành vi chuẩn**: **luôn append** ảnh **xuống cuối danh sách hàng hiện có** (không lấp chỗ trống).
- Quy trình khuyến nghị:
  1. New Project → Import Ảnh… (multi-select) → ảnh “đổ” vào các hàng **mới phía dưới**.
  2. Sau đó Import Văn bản… để ghép 1–1 theo thứ tự (xem mục 4).

> Có thể Import Ảnh… **nhiều lần**; mỗi lần đều **thêm tiếp** vào cuối.

---

## 4) Import Văn bản… (SRT/TXT) – Menu File & Toolbar

### 4.1. SRT
- **Mỗi block thời gian** trong SRT → **1 hàng văn bản**.
- Nếu **đã có ảnh sẵn**: tự động **ghép 1–1** theo thứ tự:  
  Ảnh 1 ↔ Block 1, Ảnh 2 ↔ Block 2, …
- Nếu **dư text** (nhiều block hơn ảnh): phần dư sẽ được **append** thành **hàng text-only** ở cuối.
- Nếu **dư ảnh**: các ảnh dư sẽ **giữ text trống** (có thể import thêm văn bản sau).

### 4.2. TXT
- **Mỗi đoạn** (tách theo **dòng trống**; nếu không có, tách **từng dòng**) → **1 hàng văn bản**.
- Cơ chế ghép **tương tự SRT**: ưu tiên **điền vào các hàng đã có ảnh theo thứ tự**, phần dư **append** text-only.

> Hai hàm tiện ích đã có trong `core/utils.py`:
> - `parse_srt_to_text_blocks(srt_content) -> list[str]`
> - `split_txt_to_paragraphs(txt_content) -> list[str]`

---

## 5) Prompt (Gemini) trên Toolbar – **hiện/ẩn đúng yêu cầu**
**Vấn đề trước đó**: Prompt combobox không hiện khi chọn **Gemini**.  
**Đã sửa**: Trong `MainWindow._on_tool_changed`, **label “Prompt:”** và **combobox Prompt** sẽ **cùng ẩn/hiện** theo công cụ:
```python
def _on_tool_changed(self, text):
    is_gemini = (text == "Gemini")
    self.lbl_prompt.setVisible(is_gemini)
    self.combo_prompt.setVisible(is_gemini)
```
- Khi dropdown công cụ chọn **Gemini** → Prompt **hiện ra**.
- Khi chọn công cụ khác (OCR/…) → Prompt **ẩn đi**.

> Prompt combobox lấy danh sách từ **Prompt Manager** (Tools → Prompt Manager…).

---

## 6) Gọi Gemini CLI (điền logic sau)
- Tài liệu tích hợp chi tiết: **logic.md** (adapter `AIClient`, command template, giữ ngữ cảnh…).
- Ý tưởng: bấm **Run** → gom ảnh + prompt + context → **gọi Gemini CLI** → **ghi output** vào ô **Văn bản** của từng hàng.
- Bạn chỉ cần:
  1) Cấu hình **command template** (API Manager).  
  2) Thay `MainWindow._action_run_stub` → `_action_run` theo hướng dẫn trong **logic.md**.

---

## 7) Cắt ảnh (Crop)
- Tài liệu chi tiết: **crop.md** (dialog crop, rubber band + handle, trả ảnh theo **độ phân giải gốc**).
- Chuột phải trên **Ảnh** → **Cắt ảnh…** → chọn vùng → OK → ảnh hàng được thay bằng kết quả crop.

---

## 8) Mẹo vận hành
- Quy trình nhanh:  
  1) **Import Ảnh…** (append xuống cuối).  
  2) **Import Văn bản…** (SRT/TXT) → **ghép 1–1** với ảnh theo thứ tự.  
  3) Kiểm tra/biên tập text.  
  4) (Tùy chọn) **Crop** ảnh.  
  5) **Run** Gemini để tóm tắt/viết thoại (theo prompt).  
  6) Save / Export.
- Có thể lặp lại **Import Ảnh** hoặc **Import Văn bản** nhiều lần; hệ thống luôn giữ nguyên thứ tự và ghép hợp lý.

---

## 9) Ghi chú kỹ thuật
- **Save/Load** Project: JSON; trước khi Save nên đồng bộ UI ↔ `ProjectManager.data`.
- **Giữ ngữ cảnh**: checkbox trên Toolbar; khi bật, lịch sử được nối vào prompt theo **logic.md**.
- **Recent Projects**: lưu qua `QSettings`.
- Dễ mở rộng: thêm provider (OpenAI, Local OCR…), thêm pipeline xử lý (OCR→dịch→rewrite→SRT).

---

**Kết thúc v1** – Bạn hãy dùng v1 như khung chuẩn. Khi cần, xem thêm `logic.md` và `crop.md` để “điền logic” gọi Gemini CLI và cắt ảnh.
