# v2.md – Hướng dẫn triển khai (phiên bản 2)

## 1. Quản lý đường dẫn (Last-used directories)
- Các chức năng **Import Ảnh**, **Import Văn bản**, **Save**, **Export Project** đều nhớ lại thư mục cuối cùng.  
- Lưu qua `QSettings`:
  - `Settings.get_last_dir("import_images")`  
  - `Settings.set_last_dir("import_images", path)`  
- Khi mở hộp thoại chọn file, luôn truyền `directory=Settings.get_last_dir(...)` để bắt đầu từ thư mục đã dùng gần nhất.

---

## 2. API Keys (đa khoá + retry)
- Cho phép nhập nhiều API keys trong **API Manager** (mỗi dòng 1 key).  
- Keys được lưu thành danh sách trong `QSettings`.  
- Khi chạy:
  - Lấy ngẫu nhiên 1 key.  
  - Nếu lỗi (quota, mạng, 429…) → thử key khác.  
  - Hết key thì bỏ qua ảnh đó.  

---

## 3. Ngữ cảnh (Context)
- Khi bật **“Giữ ngữ cảnh”**:
  - Lấy lại **6–7 đoạn gần nhất** từ project (`prompt + response`).  
  - Ghép vào prompt hiện tại gửi API.  
- Nếu hàng đầu tiên thì không có ngữ cảnh.

---

## 4. Xử lý tuần tự ảnh
- Chạy **lần lượt từng ảnh**, không đồng loạt.  
- Mỗi ảnh:
  - Tạo prompt (kèm/không kèm ngữ cảnh).  
  - Gọi Gemini CLI với API key đã chọn.  
  - Nếu thành công → ghi text vào cột phải + đưa vào lịch sử ngữ cảnh.  
  - Nếu lỗi → đổi key khác rồi chạy lại.

---

## 5. Gemini CLI wrapper (run.py)
- App gọi `python run.py --model MODEL --prompt PROMPT --image IMAGE`.  
- `run.py`:
  - Nhận tham số.  
  - Gọi Gemini CLI thực tế bằng `subprocess`.  
  - Trả kết quả qua stdout cho app.  

Ví dụ:
```bash
python run.py --model gemini-1.5-pro --prompt-file tmp.txt --image sample.png
```

---

## 6. Crop trực tiếp (không cần menu)
- **Khác v1**: không cần click phải → chọn “Cắt”.  
- Thay vào đó:
  - Ngay trong **khung edit**, con trỏ chuột mặc định cho phép **click–kéo để crop trực tiếp**.  
  - Người dùng chỉ cần rê chuột chọn vùng.  
  - Khi thả chuột → preview vùng crop.  
  - Nhấn Enter → thay ảnh cũ bằng ảnh đã crop.  
- Có thể thêm tùy chọn trong Toolbar: “Crop Mode ON/OFF” để bật/tắt.  

---

## 7. Undo / Redo
- Thêm **Undo/Redo stack** trong app:  
  - Mỗi thao tác (thêm ảnh, xóa ảnh, crop, sửa text…) đều push vào stack.  
  - **Undo**: quay lại bước trước.  
  - **Redo**: tiến tới bước sau.  
- Thao tác liên quan:
  - Menu Edit → Undo, Redo.  
  - Toolbar nút Undo/Redo.  
  - Shortcut: Ctrl+Z / Ctrl+Y.

---

## 8. Checklist triển khai
- [ ] Lưu đường dẫn cuối cùng bằng `QSettings`.  
- [ ] API Manager hỗ trợ nhiều key, retry ngẫu nhiên.  
- [ ] Giữ ngữ cảnh 6–7 đoạn.  
- [ ] Xử lý tuần tự từng ảnh.  
- [ ] Wrapper `run.py` để gọi Gemini CLI.  
- [ ] Crop trực tiếp bằng thao tác kéo chuột trên ảnh.  
- [ ] Undo/Redo stack cho mọi thao tác.

---

## 9. Hướng phát triển thêm
- Thêm quản lý Prompt (import/export).  
- Thêm plugin OCR.  
- Tích hợp provider khác ngoài Gemini.  
